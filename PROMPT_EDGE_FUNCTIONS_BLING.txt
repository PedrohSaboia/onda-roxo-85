# ğŸ”§ Prompt para Ajustar Edge Functions do Bling

VocÃª Ã© um desenvolvedor backend especialista em **Supabase Edge Functions** e integraÃ§Ãµes com APIs externas (Bling API).

Preciso que vocÃª ajuste as **6 Edge Functions** listadas abaixo para garantir que funcionem corretamente com chamadas do frontend via `supabase.functions.invoke()`.

---

## ğŸ“‹ Edge Functions que precisam ser ajustadas:

1. **`consultar_cliente_bling`** - Consulta se cliente existe no Bling pelo CPF/CNPJ
2. **`criar_cliente_bling`** - Cria novo cliente no Bling
3. **`editar_cliente_bling`** - Atualiza dados de cliente existente no Bling
4. **`consultar_pedido_bling`** - Verifica se pedido jÃ¡ existe no Bling
5. **`criar_pedido_bling`** - Cria novo pedido de venda no Bling
6. **`editar_pedido_bling`** - Atualiza pedido existente no Bling

---

## âš™ï¸ Requisitos obrigatÃ³rios:

### 1. **Headers CORS**
Todas as edge functions devem retornar os headers corretos para evitar erros de CORS:

```typescript
const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

// No handler OPTIONS:
if (req.method === 'OPTIONS') {
  return new Response('ok', { headers: corsHeaders })
}

// Em todas as responses:
return new Response(JSON.stringify(data), {
  headers: { ...corsHeaders, 'Content-Type': 'application/json' },
  status: 200
})
```

### 2. **Estrutura de Request/Response**

Cada funÃ§Ã£o deve:
- Aceitar dados via `req.json()`
- Validar campos obrigatÃ³rios
- Fazer chamada Ã  API do Bling com autenticaÃ§Ã£o
- Retornar JSON estruturado com status claro

### 3. **AutenticaÃ§Ã£o com Bling**

Usar token de acesso armazenado em variÃ¡vel de ambiente:

```typescript
const BLING_ACCESS_TOKEN = Deno.env.get('BLING_ACCESS_TOKEN')

const headers = {
  'Authorization': `Bearer ${BLING_ACCESS_TOKEN}`,
  'Content-Type': 'application/json',
  'Accept': 'application/json'
}
```

### 4. **Tratamento de erros**

```typescript
try {
  // lÃ³gica
} catch (error) {
  console.error('Erro:', error)
  return new Response(
    JSON.stringify({ 
      error: error.message || 'Erro desconhecido',
      details: error 
    }),
    { 
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
      status: 500 
    }
  )
}
```

---

## ğŸ“¦ Estruturas de Dados Esperadas

### **1. consultar_cliente_bling**

**Input:**
```json
{
  "documento": "12345678900"
}
```

**Output (existe):**
```json
{
  "existe": true,
  "contato_id": "12345678",
  "dados": { /* dados do cliente */ }
}
```

**Output (nÃ£o existe):**
```json
{
  "existe": false,
  "contato_id": null
}
```

---

### **2. criar_cliente_bling**

**Input:**
```json
{
  "nome": "JoÃ£o Silva",
  "documento": "12345678900",
  "email": "joao@email.com",
  "telefone": "11999999999",
  "endereco": "Rua ABC",
  "numero": "123",
  "complemento": "Apto 10",
  "bairro": "Centro",
  "cidade": "SÃ£o Paulo",
  "estado": "SP",
  "cep": "01234567"
}
```

**Output:**
```json
{
  "success": true,
  "contato_id": "12345678",
  "message": "Cliente criado com sucesso"
}
```

---

### **3. editar_cliente_bling**

**Input:**
```json
{
  "contato_id": "12345678",
  "nome": "JoÃ£o Silva Atualizado",
  "documento": "12345678900",
  "email": "joao.novo@email.com",
  "telefone": "11988888888",
  "endereco": "Rua XYZ",
  "numero": "456",
  "complemento": "Casa 2",
  "bairro": "Jardim",
  "cidade": "SÃ£o Paulo",
  "estado": "SP",
  "cep": "07654321"
}
```

**Output:**
```json
{
  "success": true,
  "message": "Cliente atualizado com sucesso"
}
```

---

### **4. consultar_pedido_bling**

**Input:**
```json
{
  "documento": "12345678900",
  "numero_loja": "PED-001"
}
```

**Output (existe):**
```json
{
  "existe": true,
  "id_pedido_venda": "987654321"
}
```

**Output (nÃ£o existe):**
```json
{
  "existe": false,
  "id_pedido_venda": null
}
```

---

### **5. criar_pedido_bling**

**Input:**
```json
{
  "contato_id": "12345678",
  "numero_loja": "PED-001",
  "data": "2025-01-15",
  "itens": [
    {
      "sku": "PROD-123",
      "descricao": "Produto Teste",
      "quantidade": 2,
      "valor_unitario": 50.00
    }
  ],
  "cliente": {
    "nome": "JoÃ£o Silva",
    "documento": "12345678900",
    "email": "joao@email.com",
    "telefone": "11999999999"
  },
  "frete": {
    "transportadora": "Correios",
    "valor": 15.00,
    "prazo": "5 dias Ãºteis"
  },
  "observacoes": "Pedido urgente"
}
```

**Output:**
```json
{
  "success": true,
  "id_pedido_venda": "987654321",
  "message": "Pedido criado com sucesso"
}
```

---

### **6. editar_pedido_bling**

**Input:**
```json
{
  "id_pedido_venda": "987654321",
  "numero_loja": "PED-001",
  "data": "2025-01-16",
  "contato_id": "12345678",
  "itens": [
    {
      "sku": "PROD-456",
      "descricao": "Produto Atualizado",
      "quantidade": 3,
      "valor_unitario": 75.00
    }
  ]
}
```

**Output:**
```json
{
  "success": true,
  "message": "Pedido atualizado com sucesso"
}
```

---

## ğŸ¯ Endpoints da API Bling (referÃªncia)

- **Consultar contato:** `GET https://api.bling.com.br/Api/v3/contatos?criterio=documento&valor={documento}`
- **Criar contato:** `POST https://api.bling.com.br/Api/v3/contatos`
- **Editar contato:** `PUT https://api.bling.com.br/Api/v3/contatos/{id}`
- **Consultar pedido:** `GET https://api.bling.com.br/Api/v3/pedidos/vendas?numeroLoja={numero}`
- **Criar pedido:** `POST https://api.bling.com.br/Api/v3/pedidos/vendas`
- **Editar pedido:** `PUT https://api.bling.com.br/Api/v3/pedidos/vendas/{id}`

---

## âœ… Checklist de entrega:

Para cada uma das 6 edge functions, vocÃª deve:

- [ ] Adicionar headers CORS completos
- [ ] Validar entrada de dados
- [ ] Fazer chamada correta Ã  API do Bling
- [ ] Tratar erros adequadamente
- [ ] Retornar JSON padronizado
- [ ] Adicionar logs para debugging (console.log)
- [ ] Testar localmente se possÃ­vel

---

## ğŸ“ Exemplo completo de estrutura:

```typescript
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

serve(async (req) => {
  // Handle CORS preflight
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    const BLING_ACCESS_TOKEN = Deno.env.get('BLING_ACCESS_TOKEN')
    
    if (!BLING_ACCESS_TOKEN) {
      throw new Error('Token do Bling nÃ£o configurado')
    }

    // Parse request body
    const body = await req.json()
    
    // Validate required fields
    if (!body.documento) {
      throw new Error('Campo "documento" Ã© obrigatÃ³rio')
    }

    console.log('ğŸ“‹ Dados recebidos:', body)

    // Call Bling API
    const response = await fetch(
      `https://api.bling.com.br/Api/v3/contatos?criterio=documento&valor=${body.documento}`,
      {
        headers: {
          'Authorization': `Bearer ${BLING_ACCESS_TOKEN}`,
          'Accept': 'application/json'
        }
      }
    )

    const data = await response.json()
    console.log('âœ… Resposta da API Bling:', data)

    // Return formatted response
    return new Response(
      JSON.stringify({
        existe: data.data && data.data.length > 0,
        contato_id: data.data?.[0]?.id || null,
        dados: data.data?.[0] || null
      }),
      {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 200
      }
    )

  } catch (error) {
    console.error('âŒ Erro:', error)
    return new Response(
      JSON.stringify({ 
        error: error.message,
        details: error 
      }),
      {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 500
      }
    )
  }
})
```

---

## ğŸš€ Prioridade de implementaÃ§Ã£o:

1. **consultar_cliente_bling** (mais crÃ­tica)
2. **criar_cliente_bling**
3. **editar_cliente_bling**
4. **criar_pedido_bling**
5. **consultar_pedido_bling**
6. **editar_pedido_bling**

---

**Importante:** Certifique-se de que todas as funÃ§Ãµes estÃ£o deployadas no Supabase e que a variÃ¡vel de ambiente `BLING_ACCESS_TOKEN` estÃ¡ configurada no painel do Supabase em **Edge Functions â†’ Settings â†’ Secrets**.
