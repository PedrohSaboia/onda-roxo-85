# Sistema de Hist√≥rico de Movimenta√ß√µes

Este documento explica como usar o sistema de hist√≥rico de movimenta√ß√µes para rastrear altera√ß√µes nos pedidos.

## Tabela no Banco de Dados

A tabela `historico_movimentacoes` armazena todas as altera√ß√µes feitas nos pedidos:

```sql
create table public.historico_movimentacoes (
  id bigint generated by default as identity not null,
  created_at timestamp with time zone not null default now(),
  alteracao text null,
  user_id uuid null,
  pedido_id uuid null,
  constraint historico_movimentacoes_pkey primary key (id),
  constraint historico_movimentacoes_pedido_id_fkey foreign key (pedido_id) references pedidos (id) on delete cascade,
  constraint historico_movimentacoes_user_id_fkey foreign key (user_id) references usuarios (id) on delete set null
);
```

## Como Usar

### 1. Importar a fun√ß√£o

```typescript
import { registrarHistoricoMovimentacao } from '@/lib/historicoMovimentacoes';
```

### 2. Registrar uma movimenta√ß√£o

Sempre que um pedido for atualizado, registre a movimenta√ß√£o:

```typescript
// Ap√≥s atualizar o pedido no banco
const { error } = await supabase.from('pedidos').update(updateData).eq('id', pedidoId);
if (error) throw error;

// Registrar no hist√≥rico
await registrarHistoricoMovimentacao(
  pedidoId,
  'Descri√ß√£o clara da altera√ß√£o realizada'
);
```

**Nota sobre user_id:** 
- O terceiro par√¢metro (userId) √© opcional
- Quando fornecido: Exibe o nome e foto do usu√°rio que realizou a altera√ß√£o
- Quando NULL ou omitido: Exibe "Autom√°tico do Banco de Dados" com √≠cone "BD" e descri√ß√£o "A√ß√£o autom√°tica via trigger"
- Use NULL para altera√ß√µes feitas por triggers do banco de dados ou processos automatizados

### 3. Exemplos de uso

#### Altera√ß√£o de Status
```typescript
await registrarHistoricoMovimentacao(
  pedidoId,
  `Status alterado para: ${statusNome}`
);
```

#### Altera√ß√£o de Respons√°vel
```typescript
await registrarHistoricoMovimentacao(
  pedidoId,
  `Respons√°vel alterado para: ${responsavelNome}`
);
```

#### Altera√ß√£o de Etiqueta de Envio
```typescript
await registrarHistoricoMovimentacao(
  pedidoId,
  `Etiqueta de envio alterada para: ${etiquetaNome}`
);
```

#### Altera√ß√£o de Plataforma
```typescript
await registrarHistoricoMovimentacao(
  pedidoId,
  `Plataforma alterada para: ${plataformaNome}`
);
```

#### Adi√ß√£o/Remo√ß√£o de Itens
```typescript
await registrarHistoricoMovimentacao(
  pedidoId,
  `Item adicionado: ${produtoNome} (Qtd: ${quantidade})`
);

await registrarHistoricoMovimentacao(
  pedidoId,
  `Item removido: ${produtoNome}`
);
```

#### Altera√ß√£o de Valor
```typescript
await registrarHistoricoMovimentacao(
  pedidoId,
  `Valor total alterado de R$ ${valorAntigo} para R$ ${valorNovo}`
);
```

#### Cancelamento/Retorno
```typescript
await registrarHistoricoMovimentacao(
  pedidoId,
  'Pedido cancelado'
);

await registrarHistoricoMovimentacao(
  pedidoId,
  `Pedido retornado. Motivo: ${motivo}`
);
```

#### Envio
```typescript
await registrarHistoricoMovimentacao(
  pedidoId,
  `Pedido enviado via ${transportadora}`
);
```

#### Uso em Triggers SQL (A√ß√µes Autom√°ticas)
```sql
-- Exemplo de trigger que registra no hist√≥rico
begin
  -- Atualizar o pedido
  update pedidos
    set status_id = 'novo-status-id',
        etiqueta_envio_id = 'nova-etiqueta-id'
  where id = NEW.id;

  -- Registrar no hist√≥rico sem user_id (a√ß√£o autom√°tica)
  insert into historico_movimentacoes (pedido_id, alteracao, user_id)
  values (NEW.id, 'Descri√ß√£o da altera√ß√£o autom√°tica', null);

  return NEW;
end;
```

**Resultado no front-end:** Quando `user_id` √© `null`, o sistema exibe automaticamente:
- Nome: "Autom√°tico do Banco de Dados"
- Avatar: "BD"
- Descri√ß√£o: "A√ß√£o autom√°tica via trigger"

## Locais Principais para Implementar

**Todas as principais opera√ß√µes de atualiza√ß√£o de pedidos j√° est√£o implementadas!** ‚úÖ

O sistema registra automaticamente as seguintes movimenta√ß√µes:

### Altera√ß√µes de Campos do Pedido
- Status do pedido
- Plataforma de venda
- Respons√°vel pelo pedido
- Etiqueta de envio

### Opera√ß√µes com Itens
- Adi√ß√£o de produtos ao pedido
- Remo√ß√£o de produtos do pedido
- Altera√ß√£o de valores totais

### Opera√ß√µes de Log√≠stica
- Envio ao carrinho do Melhor Envio
- C√°lculo de frete

### Opera√ß√µes Administrativas
- Duplica√ß√£o de pedidos
- Exclus√£o de pedidos

### ‚úÖ J√° Implementado

- `src/pages/Comercial.tsx`:
  - ‚úÖ Altera√ß√£o de status
  - ‚úÖ Altera√ß√£o de etiqueta de envio
  - ‚úÖ Altera√ß√£o de plataforma
  - ‚úÖ Altera√ß√£o de respons√°vel
  - ‚úÖ Envio ao carrinho Melhor Envio (com e sem c√°lculo de frete)
  - ‚úÖ Marca√ß√£o de pedido duplicado
  - ‚úÖ Exclus√£o de pedidos

- `src/pages/Pedido.tsx`:
  - ‚úÖ Remo√ß√£o de itens do pedido
  - ‚úÖ Adi√ß√£o de produtos e pagamentos
  - ‚úÖ Altera√ß√£o de status, plataforma, respons√°vel e etiqueta

- `src/pages/PedidoContabilidade.tsx`:
  - ‚úÖ Remo√ß√£o de itens do pedido
  - ‚úÖ Adi√ß√£o de produtos
  - ‚úÖ Altera√ß√£o de status, plataforma, respons√°vel e etiqueta

- `src/pages/PedidosCancelados.tsx`:
  - ‚úÖ Marca√ß√£o de pedido duplicado

- `src/pages/PedidosEnviados.tsx`:
  - ‚úÖ Marca√ß√£o de pedido duplicado

### üî≤ Pendente de Implementa√ß√£o (Opcional)

## Visualiza√ß√£o do Hist√≥rico

O hist√≥rico pode ser visualizado na p√°gina "Hist√≥rico de Movimenta√ß√µes" acess√≠vel pelo menu principal.

A p√°gina permite:
- Visualizar todas as movimenta√ß√µes em ordem cronol√≥gica
- Buscar por altera√ß√£o, usu√°rio ou ID do pedido (id_externo)
- Exportar para CSV
- Atualizar a lista

## Fun√ß√£o de Busca

Para buscar movimenta√ß√µes programaticamente:

```typescript
import { buscarHistoricoMovimentacoes } from '@/lib/historicoMovimentacoes';

// Buscar todas as movimenta√ß√µes
const { data, error } = await buscarHistoricoMovimentacoes({ limit: 100 });

// Buscar movimenta√ß√µes de um pedido espec√≠fico
const { data, error } = await buscarHistoricoMovimentacoes({ 
  pedidoId: 'uuid-do-pedido' 
});

// Buscar movimenta√ß√µes de um usu√°rio
const { data, error } = await buscarHistoricoMovimentacoes({ 
  userId: 'uuid-do-usuario' 
});

// Buscar com filtro de data
const { data, error } = await buscarHistoricoMovimentacoes({ 
  dataInicio: '2026-01-01',
  dataFim: '2026-12-31',
  limit: 50
});
```

## Migra√ß√£o do Banco de Dados

Para criar a tabela no banco de dados, execute a migration:

```bash
supabase migration up
```

O arquivo de migration est√° localizado em:
`supabase/migrations/20250223000001_create_historico_movimentacoes.sql`

## Permiss√µes

As pol√≠ticas de RLS (Row Level Security) permitem:
- **SELECT**: Todos os usu√°rios autenticados podem ler o hist√≥rico
- **INSERT**: Todos os usu√°rios autenticados podem criar registros de hist√≥rico

## Boas Pr√°ticas

1. **Seja descritivo**: Escreva mensagens claras sobre o que foi alterado
2. **Inclua valores**: Quando poss√≠vel, inclua o valor anterior e o novo
3. **Registre sempre**: Toda altera√ß√£o em um pedido deve gerar um registro
4. **N√£o registre erros**: S√≥ registre altera√ß√µes que foram confirmadas no banco
5. **Use await**: A fun√ß√£o √© ass√≠ncrona, mas pode ser chamada sem await se preferir fire-and-forget

## Exemplo Completo

```typescript
import { registrarHistoricoMovimentacao } from '@/lib/historicoMovimentacoes';

async function atualizarStatusPedido(pedidoId: string, novoStatusId: string) {
  try {
    // 1. Buscar informa√ß√µes necess√°rias
    const status = await buscarStatus(novoStatusId);
    
    // 2. Atualizar no banco
    const { error } = await supabase
      .from('pedidos')
      .update({ 
        status_id: novoStatusId,
        atualizado_em: new Date().toISOString() 
      })
      .eq('id', pedidoId);
    
    if (error) throw error;
    
    // 3. Registrar no hist√≥rico
    await registrarHistoricoMovimentacao(
      pedidoId,
      `Status alterado para: ${status.nome}`
    );
    
    // 4. Atualizar estado local
    // ...
    
    return { success: true };
  } catch (error) {
    console.error('Erro ao atualizar status:', error);
    return { success: false, error };
  }
}
```

## Opera√ß√µes Rastreadas por P√°gina

### Log√≠stica (`src/pages/Logistica.tsx`)

A p√°gina de Log√≠stica rastreia as seguintes opera√ß√µes:

1. **Escaneamento de itens via c√≥digo de barras**
   - Quando: Ao bipar um item com sucesso
   - Descri√ß√£o: "Item bipado via c√≥digo de barras: [Nome do Item] ([c√≥digo])"
   - Exemplo: "Item bipado via c√≥digo de barras: Camiseta P Azul (789456123)"

2. **Gera√ß√£o de etiqueta Mercado Livre**
   - Quando: Ao gerar com sucesso uma etiqueta ML
   - Descri√ß√£o: "Etiqueta Mercado Livre gerada via log√≠stica (ID Externo: [id])"
   - Exemplo: "Etiqueta Mercado Livre gerada via log√≠stica (ID Externo: MLB-12345)"

3. **Gera√ß√£o de etiqueta Melhor Envio**
   - Quando: Ao gerar com sucesso uma etiqueta via Melhor Envio
   - Descri√ß√£o: "Etiqueta Melhor Envio gerada via log√≠stica (ID Externo: [id])"
   - Exemplo: "Etiqueta Melhor Envio gerada via log√≠stica (ID Externo: 98765)"

4. **Busca manual de pedido**
   - Quando: Ao carregar um pedido manualmente pelo ID
   - Descri√ß√£o: "Pedido carregado manualmente via log√≠stica (ID/ID Externo: [input])"
   - Exemplo: "Pedido carregado manualmente via log√≠stica (ID/ID Externo: MLB-12345)"

5. **Defini√ß√£o autom√°tica de remetente**
   - Quando: Ao definir automaticamente o remetente baseado na plataforma
   - Descri√ß√£o: "Remetente definido automaticamente via log√≠stica (plataforma [tipo])"
   - Exemplo: "Remetente definido automaticamente via log√≠stica (plataforma especial)"

6. **Processamento de etiqueta e envio**
   - Quando: Ao processar a etiqueta com sucesso e marcar pedido como enviado
   - Descri√ß√£o: "Pedido enviado via log√≠stica - Etiqueta gerada e status atualizado para 'Enviado' ([id])"
   - Exemplo: "Pedido enviado via log√≠stica - Etiqueta gerada e status atualizado para 'Enviado' (MLB-12345)"

